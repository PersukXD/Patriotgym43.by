{% extends 'base.html' %}

{% block title %}–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - Wikiway{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-4">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π Wikiway</h1>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –ø–∞—Ä—Å–µ—Ä–∞ -->
    <div class="row mb-5">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">‚öôÔ∏è –ü–∞—Ä—Å–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.url.id_for_label }}" class="form-label">URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
                                    {{ form.url }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.max_images.id_for_label }}" class="form-label">–ú–∞–∫—Å–∏–º—É–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:</label>
                                    {{ form.max_images }}
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4><i class="fas fa-images"></i></h4>
                    <h5>{{ total_images }}</h5>
                    <p class="mb-0">–í—Å–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4><i class="fas fa-link"></i></h4>
                    <h5>{{ total_images }}</h5>
                    <p class="mb-0">–°—Å—ã–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    {% if images %}
        <div class="row">
            {% for image in images %}
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100">
                        <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä—è–º–æ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ URL -->
                        <img src="{{ image.get_display_url }}"
                             class="card-img-top gallery-img"
                             alt="{{ image.alt_text }}"
                             style="height: 200px; object-fit: cover;"
                             onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'"
                             onclick="openModal(this)">

                        <div class="card-body">
                            <h6 class="card-title">{{ image.title|truncatechars:30 }}</h6>
                            <p class="card-text">
                                <small class="text-muted">{{ image.alt_text|truncatechars:50 }}</small>
                            </p>
                            <div class="image-info">
                                <small class="text-muted d-block">
                                    <i class="fas fa-expand"></i>
                                    {% if image.width and image.height %}
                                        {{ image.width }}√ó{{ image.height }}
                                    {% else %}
                                        –†–∞–∑–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω
                                    {% endif %}
                                </small>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar"></i> {{ image.created_at|date:"d.m.Y" }}
                                </small>
                            </div>
                        </div>

                        <div class="card-footer">
                            <div class="btn-group w-100">
                                <a href="{{ image.get_display_url }}" target="_blank"
                                   class="btn btn-sm btn-outline-primary" title="–û—Ç–∫—Ä—ã—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <a href="{{ image.image_url }}" target="_blank"
                                   class="btn btn-sm btn-info" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å URL">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-success"
                                        onclick="copyToClipboard('{{ image.get_display_url }}')"
                                        title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if images.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if images.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ images.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥
                        </a>
                    </li>
                {% endif %}

                {% for num in images.paginator.page_range %}
                    {% if images.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > images.number|add:'-3' and num < images.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if images.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ images.next_page_number }}">
                            –í–ø–µ—Ä–µ–¥ <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <div class="text-center mt-5">
            <div class="alert alert-info">
                <h4><i class="fas fa-info-circle"></i> –ì–∞–ª–µ—Ä–µ—è –ø—É—Å—Ç–∞</h4>
                <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä—Å–µ—Ä –≤—ã—à–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–∞–π—Ç–∞ Wikiway</p>
            </div>
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="modalCaption" class="text-white text-center mt-2"></div>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openModal(img) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const caption = document.getElementById('modalCaption');

        modal.style.display = "block";
        modalImg.src = img.src;
        caption.innerHTML = img.alt;
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = "none";
    }

    window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }, function(err) {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
            // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        });
    }

    function showNotification(message) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = 'alert alert-success position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 2000);
    }
</script>
{% endblock %}