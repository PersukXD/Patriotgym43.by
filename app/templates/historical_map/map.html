<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ë–µ–ª–∞—Ä—É—Å–∏</title>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap –∏ Leaflet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link rel="stylesheet" href="/static/historical_map/styles-2/styles.css">

    <style>
        /* –°–ë–†–û–° –°–¢–ò–õ–ï–ô */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –¢–ï–ú */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #000000;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --header-bg: #ffffff;
            --header-text: #2c3e50;
            --sidebar-bg: #f8f9fa;
            --sidebar-content-bg: #ffffff;
            --sidebar-header-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --sidebar-header-text: #ffffff;
            --map-bg: #ffffff;
            --card-bg: #ffffff;
            --modal-bg: #ffffff;
            --modal-text: #212529;
            --search-bg: #ffffff;
            --search-text: #000000;
            --search-border: #e9ecef;
            --search-placeholder: #6c757d;
            --quest-section-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --section-bg: #ffffff;
            --category-bg: #ffffff;
            --category-text: #000000;
            --category-border: #dee2e6;
            --event-active-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --event-active-text: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --header-bg: #1e293b;
            --header-text: #f1f5f9;
            --sidebar-bg: #1e293b;
            --sidebar-content-bg: #1e293b;
            --sidebar-header-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --sidebar-header-text: #ffffff;
            --map-bg: #0f172a;
            --card-bg: #1e293b;
            --modal-bg: #1e293b;
            --modal-text: #f1f5f9;
            --search-bg: #334155;
            --search-text: #f1f5f9;
            --search-border: #475569;
            --search-placeholder: #94a3b8;
            --quest-section-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --section-bg: #1e293b;
            --category-bg: #334155;
            --category-text: #f1f5f9;
            --category-border: #475569;
            --event-active-bg: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            --event-active-text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            transition: all 0.5s ease;
        }

        /* –ö–ù–û–ü–ö–ê –°–ú–ï–ù–´ –¢–ï–ú–´ –í –ü–†–ê–í–û–ú –£–ì–õ–£ */
        .theme-toggle-right {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle-right:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .theme-toggle-right.rotating i {
            animation: rotateTheme 0.6s ease;
        }

        @keyframes rotateTheme {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .theme-toggle-right i {
            font-size: 1.3rem;
            color: var(--text-primary);
            transition: all 0.4s ease;
        }

        /* –®–ê–ü–ö–ê */
        header {
            background-color: var(--header-bg) !important;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            min-height: 70px;
            display: flex;
            align-items: center;
        }

        .header-container {
            padding: 0.75rem 0;
            max-width: 100%;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            flex-wrap: wrap;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –õ–û–ì–û–¢–ò–ü–ê */
        .logo-container {
            display: flex;
            align-items: center;
            text-decoration: none;
            margin-right: 10px;
        }

        .logo-image {
            height: 45px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .logo-image:hover {
            transform: scale(1.05);
        }

        .nav-list {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            align-items: center;
            margin-right: 25px;
        }

        .nav-link {
            color: var(--header-text) !important;
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            text-decoration: none;
            display: inline-block;
        }

        .nav-link:hover {
            color: #3498db !important;
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
            text-decoration: none;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: #3498db;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover::after {
            width: 80%;
        }

        /* –ü–û–ò–°–ö */
        .search-form {
            position: relative;
            min-width: 410px;
            flex-grow: 1;
            max-width: 610px;
            margin: 0 1.5rem 0 0;
            transform: translateX(-10px);
        }

        .search-input-group {
            width: 100%;
            display: flex;
        }

        .search-input {
            background-color: var(--search-bg) !important;
            color: var(--search-text) !important;
            border: 2px solid var(--search-border);
            border-radius: 25px 0 0 25px !important;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            flex: 1;
        }

        .search-input::placeholder {
            color: var(--search-placeholder) !important;
        }

        .search-input:focus {
            background-color: var(--search-bg) !important;
            color: var(--search-text) !important;
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            outline: none;
        }

        .search-btn {
            border-radius: 0 25px 25px 0 !important;
            border: 2px solid var(--search-border);
            border-left: none;
            padding: 0.75rem 1.5rem;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò –î–õ–Ø –ö–ù–û–ü–û–ö */
        .animated-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .animated-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .animated-btn:hover::before {
            left: 100%;
        }

        .animated-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .animated-btn:active {
            transform: translateY(-1px);
        }

        .search-btn:hover {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 2px solid #3498db;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-result-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-primary) !important;
        }

        .search-result-item:hover {
            background-color: var(--bg-secondary);
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary) !important;
            font-size: 1rem;
        }

        .search-result-date {
            font-size: 0.875rem;
            color: var(--text-secondary) !important;
        }

        .search-result-type {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            color: var(--text-secondary) !important;
        }

        .no-results {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary) !important;
            font-size: 1rem;
        }

        /* –ö–ù–û–ü–ö–ò –° –ê–ù–ò–ú–ê–¶–ò–Ø–ú–ò */
        .btn-outline-light {
            color: var(--header-text) !important;
            border-color: var(--header-text) !important;
            background: transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            border: 1px solid;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-outline-light:hover {
            background-color: var(--header-text) !important;
            color: var(--header-bg) !important;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-warning {
            background-color: #3498db !important;
            border-color: #3498db !important;
            color: white !important;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            border: 1px solid;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-warning:hover {
            background-color: #2980b9 !important;
            border-color: #2980b9 !important;
            transform: translateY(-2px);
            color: white !important;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        /* –í–´–†–ê–í–ù–ò–í–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–û–í */
        .header-buttons {
            display: flex;
            align-items: center;
            white-space: nowrap;
            transform: translateX(-10px);
            margin-left: 25px;
        }

        .header-buttons .btn-outline-light {
            margin-right: 12px !important;
        }

        /* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
        .map-app-container {
            display: flex;
            height: calc(100vh - 70px);
            margin-top: 70px;
            background: var(--bg-primary);
            transition: background-color 0.5s ease;
        }

        /* –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –ö–ê–†–¢–´ */
        .sidebar {
            width: 420px;
            min-width: 380px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            transition: all 0.5s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: var(--sidebar-header-bg);
            color: var(--sidebar-header-text);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.5s ease;
            width: 420px;
            min-width: 380px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--sidebar-content-bg);
            transition: all 0.5s ease;
            width: 440px;
            min-width: 380px;
        }

        .main-content {
            flex: 1;
            position: relative;
            height: 100%;
            background: var(--map-bg);
            transition: background-color 0.5s ease;
        }

        #historical-map {
            width: 100%;
            height: 100%;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ë–õ–û–ö–û–í –í –°–ê–ô–î–ë–ê–†–ï */
        .quest-section {
            background: var(--quest-section-bg);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .diamond-counter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .diamond-icon {
            color: #ffd700;
            font-size: 1.4rem;
            filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.3));
            animation: diamondSparkle 2s ease-in-out infinite;
        }

        @keyframes diamondSparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .quest-btn {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .quest-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255,255,255,0.2);
        }

        .cooldown-text {
            font-size: 0.8rem;
            opacity: 0.9;
            text-align: center;
            margin-top: 0.75rem;
            font-weight: 500;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--section-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.5s ease;
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e1f5fe;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-select-sm {
            font-size: 0.85rem;
            padding: 0.6rem 0.75rem;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            background: var(--category-bg);
            color: var(--category-text);
            transition: all 0.3s ease;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            border: 2px solid var(--category-border);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            background: var(--category-bg);
            position: relative;
            overflow: hidden;
        }

        .category-item:hover {
            border-color: #2196f3;
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.15);
        }

        .category-item.active {
            border-color: #2196f3;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
        }

        .category-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .category-item:hover .category-color {
            transform: scale(1.2);
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .event-item {
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
        }

        .event-item:hover {
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.15);
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ê–ö–¢–ò–í–ù–û–ô –ö–ê–†–¢–û–ß–ö–ò - –û–°–¢–ê–ï–¢–°–Ø –¢–ï–ú–ù–û–ô */
        .event-item.active {
            border-color: #2196f3;
            background: var(--event-active-bg);
            color: var(--event-active-text);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
        }

        .event-item.active .event-title {
            color: var(--event-active-text) !important;
        }

        .event-item.active .event-description {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .event-item.active .event-date {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .event-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }

        .event-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .event-date {
            font-size: 0.8rem;
            color: #2196f3;
            background: #e1f5fe;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .event-category {
            font-size: 0.75rem;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .event-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            transition: color 0.3s ease;
        }

        .timeline-container {
            padding: 1.5rem;
            background: var(--sidebar-content-bg);
            border-top: 1px solid var(--border-color);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .timeline-years {
            font-size: 0.85rem;
            color: #2196f3;
            font-weight: 500;
        }

        .timeline-slider {
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            border: 3px solid white;
            transition: all 0.3s ease;
        }

        .timeline-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ó–ê–î–ê–ù–ò–ô –° –¢–ï–ú–ù–û–ô –¢–ï–ú–û–ô */
        .quest-modal .modal-content {
            background: var(--modal-bg);
            color: var(--modal-text);
            border-radius: 20px;
            overflow: hidden;
            border: none;
            box-shadow: 0 25px 50px rgba(33, 150, 243, 0.3);
            animation: modalSlideIn 0.5s ease-out;
            transition: all 0.5s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .quest-modal .modal-header {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 1.5rem;
        }

        .quest-modal .modal-body {
            background: var(--modal-bg);
            color: var(--modal-text);
            padding: 2rem;
        }

        .quest-modal .modal-footer {
            background: var(--modal-bg);
            border-top: 1px solid var(--border-color);
            padding: 1.5rem;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
        .topic-btn, .difficulty-btn {
            padding: 1.25rem;
            border: 2px solid var(--category-border);
            border-radius: 15px;
            background: var(--category-bg);
            color: var(--category-text);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .topic-btn:hover, .difficulty-btn:hover {
            border-color: #2196f3;
            background: var(--bg-secondary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.15);
        }

        .topic-btn.active, .difficulty-btn.active {
            border-color: #2196f3;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .difficulty-easy {
            color: #28a745;
            font-weight: 600;
        }

        .difficulty-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .difficulty-hard {
            color: #dc3545;
            font-weight: 600;
        }

        .topic-btn.active .difficulty-easy,
        .topic-btn.active .difficulty-medium,
        .topic-btn.active .difficulty-hard,
        .difficulty-btn.active .difficulty-easy,
        .difficulty-btn.active .difficulty-medium,
        .difficulty-btn.active .difficulty-hard {
            color: white !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
        .quest-modal .form-control {
            background: var(--search-bg);
            color: var(--search-text);
            border: 2px solid var(--search-border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .quest-modal .form-control:focus {
            background: var(--search-bg);
            color: var(--search-text);
            border-color: #2196f3;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }

        .quest-modal .form-label {
            color: var(--modal-text);
            font-weight: 500;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –í–´–•–û–î–ê */
        .logout-modal .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.4s ease-out;
            overflow: hidden;
            border: none;
            background: var(--modal-bg);
            color: var(--modal-text);
            transition: all 0.5s ease;
        }

        .logout-modal .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.2);
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .logout-modal .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255,255,255,0.4) 50%,
                transparent 100%);
            animation: shine 3s infinite;
            z-index: 1;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .logout-modal .modal-header .modal-title {
            position: relative;
            z-index: 2;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .logout-modal .modal-header .btn-close {
            filter: invert(1);
            opacity: 0.8;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .logout-modal .modal-header .btn-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .logout-modal .modal-body {
            padding: 2rem;
            text-align: center;
            font-size: 1.1rem;
            background: var(--bg-secondary);
        }

        .logout-modal .modal-body i.bi-person-check {
            font-size: 3rem;
            color: #007bff !important;
            margin-bottom: 1rem;
            display: block;
        }

        .logout-modal .modal-footer {
            border-top: 1px solid var(--border-color);
            justify-content: center;
            padding: 1.5rem;
            background: var(--modal-bg);
            gap: 1rem;
        }

        .logout-modal .btn {
            min-width: 120px;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
        }

        .logout-modal .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .logout-modal .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .logout-modal .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .logout-modal .btn:active {
            transform: translateY(0);
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–Ø –û–ë –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        .auth-required-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 70px);
            margin-top: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-required-card {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            transition: all 0.5s ease;
        }

        .auth-required-icon {
            font-size: 4rem;
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–†–¢–û–ô */
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—á–µ–∫ */
        .marker-hidden {
            display: none !important;
        }

        .category-filter-active {
            animation: pulse-filter 1.5s ease-in-out;
        }

        @keyframes pulse-filter {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* –£–¢–ò–õ–ò–¢–´ */
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-center { justify-content: center; }
        .justify-content-between { justify-content: space-between; }
        .flex-wrap { flex-wrap: wrap; }
        .me-2 { margin-right: 0.5rem; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mt-1 { margin-top: 0.25rem; }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .text-decoration-none { text-decoration: none; }
        .fw-bold { font-weight: bold; }
        .fs-4 { font-size: 1.5rem; }
        .small { font-size: 0.875rem; }
        .opacity-75 { opacity: 0.75; }
        .text-muted { color: var(--text-secondary); }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .theme-toggle-right {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }

            .theme-toggle-right i {
                font-size: 1.2rem;
            }

            .search-form {
                order: 3;
                min-width: 100%;
                max-width: 100%;
                margin: 1rem 0 0 0;
                transform: none;
            }

            .header-content {
                flex-wrap: wrap !important;
            }

            .header-buttons {
                order: 2;
                margin-left: auto;
                transform: none;
            }

            .nav-list {
                order: 1;
                margin-bottom: 1rem;
                margin-right: 0;
            }

            .logo-container {
                margin-right: 0;
            }

            .logo-image {
                height: 35px;
                max-width: 120px;
            }

            .search-input {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .search-btn {
                padding: 0.5rem 1rem;
            }

            .header-container {
                padding: 0.5rem 0;
            }

            header {
                min-height: auto;
            }

            .map-app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 40vh;
            }

            .main-content {
                height: 60vh;
            }

            .auth-required-card {
                padding: 2rem;
                margin: 1rem;
            }

            .auth-required-icon {
                font-size: 3rem;
            }

            .sidebar {
                width: 100%;
                min-width: 100%;
            }

            .sidebar-content {
                width: 100%;
                min-width: 100%;
            }
        }

        @media (min-width: 992px) {
            .header-content {
                flex-wrap: nowrap !important;
            }

            .search-form {
                flex: 1;
                margin: 0 1.5rem 0 0;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∞–ª–º–∞–∑–æ–≤ */
        .diamond-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 10000;
            animation: diamondFloat 2s ease-out forwards;
        }

        @keyframes diamondFloat {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -60%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -80%) scale(1);
                opacity: 0;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∑–∞–¥–∞–Ω–∏–π */
        .quest-marker-icon {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.5);
            animation: markerPulse 2s ease-in-out infinite;
        }

        @keyframes markerPulse {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(33, 150, 243, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 30px rgba(33, 150, 243, 0.8);
                transform: scale(1.1);
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ø–∞–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π */
        .quest-popup-container .leaflet-popup-content-wrapper {
            border-radius: 20px;
            padding: 0;
            border: none;
            box-shadow: 0 15px 35px rgba(33, 150, 243, 0.3);
            animation: popupBounce 0.6s ease-out;
            background: var(--modal-bg);
            color: var(--modal-text);
        }

        @keyframes popupBounce {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .quest-popup-content {
            padding: 1.5rem;
            min-width: 320px;
            background: var(--modal-bg);
            color: var(--modal-text);
        }

        .quest-header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .quest-info {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
        }

        .quest-question {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            border-left: 4px solid #1976d2;
            animation: questionPulse 2s ease-in-out infinite;
        }

        @keyframes questionPulse {
            0%, 100% { border-left-color: #1976d2; }
            50% { border-left-color: #2196f3; }
        }

        .quest-answer-input {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            background: var(--search-bg);
            color: var(--search-text);
        }

        .quest-answer-input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- –ö–ù–û–ü–ö–ê –°–ú–ï–ù–´ –¢–ï–ú–´ –í –ü–†–ê–í–û–ú –£–ì–õ–£ -->
    <div class="theme-toggle-right" id="themeToggleRight" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <i class="bi bi-moon-fill"></i>
    </div>

    <!-- –®–ê–ü–ö–ê -->
    <header class="p-3">
        <div class="container header-container">
            <div class="header-content">
                <!-- –õ–û–ì–û–¢–ò–ü - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô -->
                <a href="/" class="logo-container">
                    {% load static %}
                    <img src="{% static 'Imagese/–ë–µ–∑ –∏–º–µ–Ω–∏-1.png' %}" alt="–ü–∞—Ç—Ä–∏–æ—Ç" class="logo-image" id="themeLogo">
                </a>

                <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
                <ul class="nav-list">
                    <li><a href="/" class="nav-link animated-btn">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="/news/" class="nav-link animated-btn">–ù–æ–≤–æ—Å—Ç–∏</a></li>
                    <li><a href="/feed/" class="nav-link animated-btn">–õ–µ–Ω—Ç–∞</a></li>
                    <li><a href="/historical-map/" class="nav-link animated-btn" style="color: #3498db; font-weight: 600;">–ö–∞—Ä—Ç–∞</a></li>
                    <li><a href="/courses/" class="nav-link animated-btn">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a></li>
                    <li><a href="/shop/" class="nav-link animated-btn">–ú–∞–≥–∞–∑–∏–Ω</a></li>
                </ul>

                <!-- –ü–û–ò–°–ö - –†–ê–°–®–ò–†–ï–ù–ù–´–ô -->
                <form class="search-form" id="searchForm" action="/search/" method="get">
                    <div class="search-input-group">
                        <input type="search" name="q" class="search-input" placeholder="–ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π..."
                               aria-label="Search" id="searchInput" autocomplete="off">
                        <button type="submit" class="search-btn animated-btn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </form>

                <!-- –ö–ù–û–ü–ö–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò - –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï -->
                <div class="text-end header-buttons" id="auth-buttons">
                    {% if user.is_authenticated %}
                        <a href="/profile/" class="btn-outline-light me-2 animated-btn">
                            <i class="bi bi-person-circle"></i> –ü—Ä–æ—Ñ–∏–ª—å
                        </a>
                        <button type="button" class="btn-outline-light me-2 animated-btn" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            –í—ã–π—Ç–∏
                        </button>
                    {% else %}
                        <div class="d-flex align-items-center">
                            <a href="/login/" class="btn-outline-light me-2 animated-btn">–í–æ–π—Ç–∏</a>
                            <a href="/register/" class="btn-warning animated-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø -->
    <div id="user-data"
         data-user-id="{% if user.is_authenticated %}{{ user.id }}{% else %}anonymous{% endif %}"
         data-username="{% if user.is_authenticated %}{{ user.username }}{% else %}anonymous{% endif %}"
         style="display: none;">
    </div>

    <!-- –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    {% if not user.is_authenticated %}
        <!-- –°–û–û–ë–©–ï–ù–ò–ï –î–õ–Ø –ù–ï–ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
        <div class="auth-required-container">
            <div class="auth-required-card">
                <div class="auth-required-icon">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <h2 class="mb-3">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                <p class="text-muted mb-4">
                    –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç–µ –∏ —Å–∏—Å—Ç–µ–º–µ –∑–∞–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.
                </p>
                <div class="d-grid gap-2 d-md-block">
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary btn-lg me-md-2">
                        <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                    </a>
                    <a href="{% url 'register' %}" class="btn btn-success btn-lg">
                        <i class="bi bi-person-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </a>
                </div>
            </div>
        </div>
    {% else %}
        <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
        <div class="map-app-container">
            <!-- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h1 class="h4 mb-1">üó∫Ô∏è –ò—Å—Ç–æ—Ä–∏—è</h1>
                    <p class="mb-0 small opacity-75">–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</p>
                </div>

                <div class="sidebar-content">
                    <!-- –°–ï–ö–¶–ò–Ø –ó–ê–î–ê–ù–ò–ô -->
                    <div class="quest-section">
                        <div class="diamond-counter">
                            <i class="bi bi-gem diamond-icon"></i>
                            <span id="diamond-count">0</span> –∞–ª–º–∞–∑–æ–≤
                        </div>
                        <button class="quest-btn" id="quest-button" data-bs-toggle="modal" data-bs-target="#questModal">
                            <i class="bi bi-flag"></i>
                            –ó–∞–¥–∞–Ω–∏–µ
                        </button>
                        <div class="cooldown-text" id="quest-cooldown">–ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é!</div>
                    </div>

                    <!-- –§–ò–õ–¨–¢–†–´ -->
                    <div class="section">
                        <div class="section-title">
                            <i class="bi bi-filter"></i>
                            –ü–æ–ª–æ—Å–∞ —Å–æ–±—ã—Ç–∏–π
                        </div>
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">–í–µ–∫:</label>
                                <select class="form-select form-select-sm" id="century-filter">
                                    <option value="">–í—Å–µ –≤–µ–∫–∞</option>
                                    <option value="9">IX –≤–µ–∫</option>
                                    <option value="10">X –≤–µ–∫</option>
                                    <option value="11">XI –≤–µ–∫</option>
                                    <option value="12">XII –≤–µ–∫</option>
                                    <option value="13">XIII –≤–µ–∫</option>
                                    <option value="14">XIV –≤–µ–∫</option>
                                    <option value="15">XV –≤–µ–∫</option>
                                    <option value="16">XVI –≤–µ–∫</option>
                                    <option value="17">XVII –≤–µ–∫</option>
                                    <option value="18">XVIII –≤–µ–∫</option>
                                    <option value="19">XIX –≤–µ–∫</option>
                                    <option value="20">XX –≤–µ–∫</option>
                                    <option value="21">XXI –≤–µ–∫</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>
                                <select class="form-select form-select-sm" id="type-filter">
                                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                    <option value="–æ—Å–Ω–æ–≤–∞–Ω–∏—è">–û—Å–Ω–æ–≤–∞–Ω–∏—è</option>
                                    <option value="—Ä–µ–ª–∏–≥–∏—è">–†–µ–ª–∏–≥–∏—è</option>
                                    <option value="—Å—Ä–∞–∂–µ–Ω–∏—è">–°—Ä–∞–∂–µ–Ω–∏—è</option>
                                    <option value="—Ä–µ—Ñ–æ—Ä–º—ã">–†–µ—Ñ–æ—Ä–º—ã</option>
                                    <option value="–≤–æ—Å—Å—Ç–∞–Ω–∏—è">–í–æ—Å—Å—Ç–∞–Ω–∏—è</option>
                                    <option value="–ø–æ–ª–∏—Ç–∏–∫–∞">–ü–æ–ª–∏—Ç–∏–∫–∞</option>
                                    <option value="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                                </select>
                            </div>
                        </div>

                        <div class="categories-grid" id="category-list">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </div>
                    </div>

                    <!-- –°–û–ë–´–¢–ò–Ø -->
                    <div class="section">
                        <div class="section-title">
                            <i class="bi bi-clock-history"></i>
                            –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
                        </div>

                        <div class="events-list" id="events-container">
                            <!-- –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </div>
                    </div>
                </div>

                <!-- –¢–ê–ô–ú–õ–ê–ô–ù -->
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="section-title">
                            <i class="bi bi-sliders"></i>
                            –•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞
                        </div>
                        <div class="timeline-years">800 –≥. - 2024 –≥.</div>
                    </div>
                    <input type="range" class="timeline-slider" id="timeline-slider" min="800" max="2024" value="2024">
                    <div class="text-center mt-1">
                        <small class="text-muted" id="current-year">2024 –≥.</small>
                    </div>
                </div>
            </div>

            <!-- –ö–ê–†–¢–ê -->
            <div class="main-content">
                <div id="historical-map"></div>

                <div class="map-controls">
                    <button class="control-btn" id="reset-view" title="–°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥ –∏ —Ñ–∏–ª—å—Ç—Ä—ã">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="control-btn" id="toggle-clusters" title="–ö–ª–∞—Å—Ç–µ—Ä—ã">
                        <i class="bi bi-collection"></i>
                    </button>
                    <button class="control-btn" id="show-quest-marker" title="–ö –∑–∞–¥–∞–Ω–∏—é" style="display: none;">
                        <i class="bi bi-flag"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–î–ê–ù–ò–Ø -->
        <div class="modal fade quest-modal" id="questModal" tabindex="-1" aria-labelledby="questModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="questModalLabel">
                            <i class="bi bi-flag"></i> –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- –í–´–ë–û–† –¢–ï–ú–´ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
                            <div class="row g-2" id="topic-selection">
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 topic-btn" data-topic="–æ—Å–Ω–æ–≤–∞–Ω–∏—è">
                                        –û—Å–Ω–æ–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 topic-btn" data-topic="—Å—Ä–∞–∂–µ–Ω–∏—è">
                                        –°—Ä–∞–∂–µ–Ω–∏—è
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 topic-btn" data-topic="–ø–æ–ª–∏—Ç–∏–∫–∞">
                                        –ü–æ–ª–∏—Ç–∏–∫–∞
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 topic-btn" data-topic="–∫—É–ª—å—Ç—É—Ä–∞">
                                        –ö—É–ª—å—Ç—É—Ä–∞
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –í–´–ë–û–† –°–õ–û–ñ–ù–û–°–¢–ò -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
                            <div class="row g-2" id="difficulty-selection">
                                <div class="col-4">
                                    <button class="btn btn-outline-success w-100 difficulty-btn" data-difficulty="easy">
                                        <span class="difficulty-easy">–õ–µ–≥–∫–∞—è</span><br>
                                        <small>+1 –∞–ª–º–∞–∑</small>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-warning w-100 difficulty-btn" data-difficulty="medium">
                                        <span class="difficulty-medium">–°—Ä–µ–¥–Ω—è—è</span><br>
                                        <small>+3 –∞–ª–º–∞–∑–∞</small>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-danger w-100 difficulty-btn" data-difficulty="hard">
                                        <span class="difficulty-hard">–°–ª–æ–∂–Ω–∞—è</span><br>
                                        <small>+5 –∞–ª–º–∞–∑–æ–≤</small>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- –û–ë–õ–ê–°–¢–¨ –í–û–ü–†–û–°–ê -->
                        <div id="quest-area" style="display: none;">
                            <hr>
                            <div class="quest-content">
                                <h5 id="quest-question" class="text-center mb-4"></h5>
                                <div class="mb-3">
                                    <label for="quest-answer" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                                    <input type="text" class="form-control" id="quest-answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
                                </div>
                                <div class="text-center">
                                    <button class="btn btn-success" id="submit-answer">
                                        <i class="bi bi-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button type="button" class="btn btn-primary" id="start-quest" disabled>
                            <i class="bi bi-play-circle"></i> –ù–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–•–û–î–ê -->
        <div class="modal fade logout-modal" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logoutModalLabel">
                            <i class="bi bi-question-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <i class="bi bi-person-check" style="font-size: 3rem; color: #007bff;"></i>
                        </div>
                        <p class="mb-0">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> –ù–µ—Ç, –æ—Å—Ç–∞—Ç—å—Å—è
                        </button>
                        <form method="post" action="{% url 'logout' %}" id="logoutForm">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –î–∞, –≤—ã–π—Ç–∏
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- –°–ö–†–ò–ü–¢–´ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –í–ê–®–ò JS –§–ê–ô–õ–´ –¢–û–õ–¨–ö–û –î–õ–Ø –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• -->
    {% if user.is_authenticated %}
        <script src="/static/historical_map/JS-2/data.js"></script>
        <script src="/static/historical_map/JS-2/quest-system.js"></script>
        <script src="/static/historical_map/JS-2/map-system.js"></script>
        <script src="/static/historical_map/JS-2/app.js"></script>
    {% endif %}

    <script>
        // –ú–ï–ù–ï–î–ñ–ï–† –¢–ï–ú –î–õ–Ø MAP.HTML
        class ThemeManagerMap {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'light';
                this.lightLogo = "{% static 'Imagese/–ë–µ–∑ –∏–º–µ–Ω–∏-1.png' %}";
                this.darkLogo = "{% static 'Imagese/–ë–µ–∑ –∏–º–µ–Ω–∏-2.png' %}";
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.updateToggleButton();
                this.updateLogo();
            }

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                this.currentTheme = theme;
                this.updateToggleButton();
                this.updateLogo();
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);

                const toggleBtn = document.getElementById('themeToggleRight');
                toggleBtn.classList.add('rotating');
                setTimeout(() => {
                    toggleBtn.classList.remove('rotating');
                }, 600);
            }

            updateToggleButton() {
                const toggleBtn = document.getElementById('themeToggleRight');
                const icon = toggleBtn.querySelector('i');

                if (this.currentTheme === 'dark') {
                    icon.className = 'bi bi-sun-fill';
                    toggleBtn.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
                } else {
                    icon.className = 'bi bi-moon-fill';
                    toggleBtn.title = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É';
                }
            }

            updateLogo() {
                const logoElement = document.getElementById('themeLogo');
                if (logoElement) {
                    if (this.currentTheme === 'dark') {
                        logoElement.src = this.darkLogo;
                    } else {
                        logoElement.src = this.lightLogo;
                    }
                }
            }
        }

        const themeManagerMap = new ThemeManagerMap();

        document.getElementById('themeToggleRight').addEventListener('click', function() {
            themeManagerMap.toggleTheme();
        });

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–°–ö–õ–ê–î–ö–ò –ö–õ–ê–í–ò–ê–¢–£–†–´
        function fixKeyboardLayout(text) {
            const layoutMap = {
                'q': '–π', 'w': '—Ü', 'e': '—É', 'r': '–∫', 't': '–µ', 'y': '–Ω', 'u': '–≥', 'i': '—à', 'o': '—â', 'p': '–∑',
                '[': '—Ö', ']': '—ä', 'a': '—Ñ', 's': '—ã', 'd': '–≤', 'f': '–∞', 'g': '–ø', 'h': '—Ä', 'j': '–æ', 'k': '–ª',
                'l': '–¥', ';': '–∂', "'": '—ç', 'z': '—è', 'x': '—á', 'c': '—Å', 'v': '–º', 'b': '–∏', 'n': '—Ç', 'm': '—å',
                ',': '–±', '.': '—é', '/': '.', '`': '—ë',

                '–π': 'q', '—Ü': 'w', '—É': 'e', '–∫': 'r', '–µ': 't', '–Ω': 'y', '–≥': 'u', '—à': 'i', '—â': 'o', '–∑': 'p',
                '—Ö': '[', '—ä': ']', '—Ñ': 'a', '—ã': 's', '–≤': 'd', '–∞': 'f', '–ø': 'g', '—Ä': 'h', '–æ': 'j', '–ª': 'k',
                '–¥': 'l', '–∂': ';', '—ç': "'", '—è': 'z', '—á': 'x', '—Å': 'c', '–º': 'v', '–∏': 'b', '—Ç': 'n', '—å': 'm',
                '–±': ',', '—é': '.', '—ë': '`'
            };

            let result = '';
            for (let i = 0; i < text.length; i++) {
                const char = text[i].toLowerCase();
                result += layoutMap[char] || text[i];
            }
            return result;
        }

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –†–ê–°–ö–õ–ê–î–ö–ò –¢–ï–ö–°–¢–ê
        function detectAndFixLayout(text) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä—É—Å—Å–∫–∏–º–∏ –≤ –¥—Ä—É–≥–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ
            const englishPattern = /[qwertyuiop\[\]asdfghjkl;'zxcvbnm,\.`]/i;
            const russianPattern = /[–π—Ü—É–∫–µ–Ω–≥—à—â–∑—Ö—ä—Ñ—ã–≤–∞–ø—Ä–æ–ª–¥–∂—ç—è—á—Å–º–∏—Ç—å–±—é—ë]/i;

            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –Ω–µ—Ç —Ä—É—Å—Å–∫–∏—Ö, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
            if (englishPattern.test(text) && !russianPattern.test(text)) {
                return fixKeyboardLayout(text);
            }

            return text;
        }

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò –¢–ï–ö–°–¢–ê (–ü–†–ò–í–ï–î–ï–ù–ò–ï –ö –ù–ò–ñ–ù–ï–ú–£ –†–ï–ì–ò–°–¢–†–£ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–°–ö–õ–ê–î–ö–ò)
        function normalizeSearchQuery(text) {
            // –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É
            const fixedLayout = detectAndFixLayout(text);
            // –ó–∞—Ç–µ–º –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–≥–æ –ø–æ–∏—Å–∫–∞
            return fixedLayout.toLowerCase();
        }

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú


        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ü–û–ò–°–ö–ê
        function handleSearch(query) {
            if (query && query.trim().length > 0) {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                const normalizedQuery = normalizeSearchQuery(query.trim());
                const encodedQuery = encodeURIComponent(normalizedQuery);
                window.location.href = `/search/?q=${encodedQuery}`;
            }
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            let searchTimeout;

            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const query = searchInput.value;
                    handleSearch(query);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
            const searchBtn = document.querySelector('.search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const query = searchInput.value;
                    handleSearch(query);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSearch(this.value);
                    }
                });
            }

            // –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ü–û–ò–°–ö–ê –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú –†–ê–°–ö–õ–ê–î–ö–ò
            if (searchInput && searchResults) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();

                    if (query.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 300);
                });

                searchInput.addEventListener('focus', function() {
                    const query = this.value.trim();
                    if (query.length >= 2 && searchResults.innerHTML) {
                        searchResults.style.display = 'block';
                    }
                });

                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-form')) {
                        searchResults.style.display = 'none';
                    }
                });

                searchResults.addEventListener('click', function(e) {
                    const resultItem = e.target.closest('.search-result-item');
                    if (resultItem) {
                        const searchForm = document.getElementById('searchForm');
                        searchInput.value = resultItem.querySelector('.search-result-title').textContent;
                        searchForm.submit();
                    }
                });

                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchResults.style.display = 'none';
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫–∏
                if (searchForm) {
                    searchForm.addEventListener('submit', function(e) {
                        const query = searchInput.value.trim();
                        if (query) {
                            const fixedQuery = detectAndFixLayout(query);
                            if (fixedQuery !== query) {
                                searchInput.value = fixedQuery;
                                // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                            }
                        }
                    });
                }
            }

            function performSearch(query) {
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
                const normalizedQuery = normalizeSearchQuery(query);

                // –†–µ–∞–ª—å–Ω—ã–π AJAX –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                fetch(`/search/?q=${encodeURIComponent(normalizedQuery)}&ajax=1`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displaySearchResults(data.results || [], query);
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        // –ó–∞–≥–ª—É—à–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                        const mockResults = getMockResults(normalizedQuery);
                        displaySearchResults(mockResults, query);
                    });
            }

            function getMockResults(query) {
                // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const allResults = [
                    {
                        title: '–û—Å–Ω–æ–≤–∞–Ω–∏–µ –ú–∏–Ω—Å–∫–∞',
                        date: '1067 –≥.',
                        type: 'news',
                        url: '/news/1'
                    },
                    {
                        title: '–ì—Ä—é–Ω–≤–∞–ª—å–¥—Å–∫–∞—è –±–∏—Ç–≤–∞',
                        date: '1410 –≥.',
                        type: 'event',
                        url: '/events/1'
                    },
                    {
                        title: '–ë–∏—Ç–≤–∞ –ø–æ–¥ –û—Ä—à–µ–π',
                        date: '1514 –≥.',
                        type: 'event',
                        url: '/events/2'
                    },
                    {
                        title: '–í–æ—Å—Å—Ç–∞–Ω–∏–µ –ö–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ',
                        date: '1863 –≥.',
                        type: 'news',
                        url: '/news/2'
                    },
                    {
                        title: '–°–æ–∑–¥–∞–Ω–∏–µ –í–ö–õ',
                        date: '1236 –≥.',
                        type: 'event',
                        url: '/events/3'
                    },
                    {
                        title: '–õ—é–±–ª–∏–Ω—Å–∫–∞—è —É–Ω–∏—è',
                        date: '1569 –≥.',
                        type: 'event',
                        url: '/events/4'
                    },
                    {
                        title: '–í–æ—Å—Å—Ç–∞–Ω–∏–µ 1863 –≥–æ–¥–∞',
                        date: '1863 –≥.',
                        type: 'news',
                        url: '/news/3'
                    },
                    {
                        title: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ë–ù–†',
                        date: '1918 –≥.',
                        type: 'news',
                        url: '/news/4'
                    }
                ];

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É
                return allResults.filter(result =>
                    normalizeSearchQuery(result.title).includes(normalizeSearchQuery(query))
                ).slice(0, 5); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            }

            function displaySearchResults(results, query) {
                if (!searchResults) return;

                searchResults.innerHTML = '';

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "' + query + '"</div>';
                } else {
                    results.forEach(result => {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'search-result-item';

                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                        const icon = result.type === 'news' ?
                            '<i class="bi bi-newspaper text-primary me-2"></i>' :
                            '<i class="bi bi-calendar-event text-success me-2"></i>';

                        resultElement.innerHTML = `
                            <div class="search-result-title">${icon}${result.title}</div>
                            <div class="search-result-date">${result.date}</div>
                            <div class="search-result-type">${result.type === 'news' ? '–ù–æ–≤–æ—Å—Ç—å' : '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ'}</div>
                        `;

                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        resultElement.addEventListener('click', function() {
                            window.location.href = result.url;
                        });

                        searchResults.appendChild(resultElement);
                    });
                }

                searchResults.style.display = 'block';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã—Ö–æ–¥–∞ (–∫–∞–∫ –≤ base.html)
            const logoutForm = document.getElementById('logoutForm');
            const logoutModal = document.getElementById('logoutModal');

            if (logoutForm && logoutModal) {
                logoutForm.addEventListener('submit', function(e) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã...');

                    const modal = bootstrap.Modal.getInstance(logoutModal);
                    if (modal) {
                        modal.hide();
                    }

                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –í—ã—Ö–æ–¥...';
                        submitBtn.disabled = true;
                    }
                });
            }

            if (logoutModal) {
                logoutModal.addEventListener('hidden.bs.modal', function () {
                    const submitBtn = document.querySelector('#logoutForm button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> –î–∞, –≤—ã–π—Ç–∏';
                        submitBtn.disabled = false;
                    }
                });
            }

            console.log('–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        });

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        setInterval(() => {
            if (window.questSystem && window.questSystem.isInitialized) {
                console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
                window.questSystem.forceRefresh();
            }
        }, 5000);
    </script>
</body>
</html>