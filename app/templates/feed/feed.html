{% extends 'base.html' %}
{% load static %}
{% load post_tags %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Добавлен отступ от шапки -->
            <div class="mt-3"></div>

            <div class="text-center mb-4">
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    <i class="bi bi-plus-circle"></i> Опубликовать пост
                </button>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">
                        <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">Войдите</a> или
                        <a href="{% url 'register' %}" class="alert-link">зарегистрируйтесь</a>,
                        чтобы публиковать посты, ставить лайки и комментировать
                    </p>
                </div>
                {% endif %}
            </div>

            <div id="posts-feed">
                {% for post in posts %}
                <div class="card shadow mb-4 post-card" id="post-{{ post.id }}">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <a href="{% url 'user_profile' post.author.username %}" class="text-decoration-none">
                                    <div style="position: relative; width: 50px; height: 50px; margin-right: 12px;">
                                        {% if post.author.userprofile.avatar %}
                                            <img src="{{ post.author.userprofile.avatar.url }}"
                                                 alt="Аватар"
                                                 style="width: 40px; height: 40px; object-fit: cover; position: absolute; top: 5px; left: 5px; z-index: 1; border-radius: 6px;">
                                        {% else %}
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover)); display: flex; align-items: center; justify-content: center; color: white; position: absolute; top: 5px; left: 5px; z-index: 1; border-radius: 6px;">
                                                <i class="bi bi-person-fill" style="font-size: 1rem;"></i>
                                            </div>
                                        {% endif %}

                                        {% if post.author.userprofile.active_avatar_frame %}
                                            {% if post.author.userprofile.active_avatar_frame.get_image_url %}
                                                <img src="{{ post.author.userprofile.active_avatar_frame.get_image_url }}"
                                                     alt="Рамка"
                                                     style="width: 50px; height: 50px; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none;">
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </a>
                                <div>
                                    <a href="{% url 'user_profile' post.author.username %}" class="text-decoration-none">
                                        <h6 class="mb-0">{{ post.author.username }}</h6>
                                    </a>
                                    <small class="text-muted">{{ post.created_at|date:"d M Y H:i" }}</small>
                                </div>
                            </div>

                            {% if user.is_authenticated and post|can_delete_post:user %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button type="button" class="dropdown-item text-danger delete-post-btn" data-post-id="{{ post.id }}">
                                            <i class="bi bi-trash"></i> Удалить пост
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>

                        <p class="card-text">{{ post.content|linebreaksbr }}</p>

                        {% if post.media_file %}
                            {% if post.post_type == 'image' %}
                                <img src="{{ post.media_file.url }}" class="img-fluid rounded mb-3" alt="Изображение" style="max-height: 500px; object-fit: contain;">
                            {% elif post.post_type == 'video' %}
                                <video controls class="w-100 rounded mb-3" style="max-height: 500px;">
                                    <source src="{{ post.media_file.url }}" type="video/mp4">
                                    Ваш браузер не поддерживает видео.
                                </video>
                            {% elif post.post_type == 'audio' %}
                                <div class="audio-player-side mb-3">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            {% if post.audio_cover %}
                                                <img src="{{ post.audio_cover.url }}" alt="Обложка аудио" class="audio-side-cover rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                            {% else %}
                                                <div class="audio-side-default bg-secondary rounded d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                                    <i class="bi bi-music-note-beamed text-white"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col">
                                            <div class="audio-info mb-2">
                                                <strong class="audio-title" id="audio-title-{{ post.id }}">
                                                    {% if post.media_file.name %}
                                                        {{ post.media_file.name|format_audio_filename }}
                                                    {% else %}
                                                        Аудио файл
                                                    {% endif %}
                                                </strong>
                                            </div>
                                            <audio controls class="w-100 audio-side-controls">
                                                <source src="{{ post.media_file.url }}" type="audio/mpeg">
                                                Ваш браузер не поддерживает аудио.
                                            </audio>
                                            {% if user.is_authenticated and user == post.author %}
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-secondary edit-audio-title-btn"
                                                        data-post-id="{{ post.id }}"
                                                        data-original-name="{{ post.media_file.name }}">
                                                    <i class="bi bi-pencil"></i> Изменить название
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                {% if user.is_authenticated %}
                                <button class="btn btn-outline-danger like-btn {% if user in post.likes.all %}liked{% endif %}"
                                        data-post-id="{{ post.id }}">
                                    <i class="bi bi-heart{% if user in post.likes.all %}-fill{% endif %}"></i>
                                    <span class="likes-count">{{ post.likes.count }}</span>
                                </button>
                                {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-danger">
                                    <i class="bi bi-heart"></i>
                                    <span class="likes-count">{{ post.likes.count }}</span>
                                </a>
                                {% endif %}

                                <button class="btn btn-outline-primary comment-btn" data-bs-toggle="collapse"
                                        data-bs-target="#comments-{{ post.id }}">
                                    <i class="bi bi-chat"></i>
                                    <span class="comments-count">{{ post.comments.count }}</span>
                                </button>
                            </div>
                        </div>

                        <div class="collapse mt-3" id="comments-{{ post.id }}">
                            <div class="comments-section">
                                <div class="comments-list mb-3">
                                    {% for comment in post.comments.all %}
                                    <div class="comment mb-2 p-2 rounded position-relative" id="comment-{{ comment.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-1">
                                                    <div style="position: relative; width: 32px; height: 32px; margin-right: 8px;">
                                                        {% if comment.user.userprofile.avatar %}
                                                            <img src="{{ comment.user.userprofile.avatar.url }}"
                                                                 alt="Аватар"
                                                                 style="width: 24px; height: 24px; object-fit: cover; position: absolute; top: 4px; left: 4px; z-index: 1; border-radius: 4px;">
                                                        {% else %}
                                                            <div style="width: 24px; height: 24px; background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover)); display: flex; align-items: center; justify-content: center; color: white; position: absolute; top: 4px; left: 4px; z-index: 1; border-radius: 4px;">
                                                                <i class="bi bi-person-fill" style="font-size: 0.7rem;"></i>
                                                            </div>
                                                        {% endif %}

                                                        {% if comment.user.userprofile.active_avatar_frame %}
                                                            {% if comment.user.userprofile.active_avatar_frame.get_image_url %}
                                                                <img src="{{ comment.user.userprofile.active_avatar_frame.get_image_url }}"
                                                                     alt="Рамка"
                                                                     style="width: 32px; height: 32px; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none;">
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between">
                                                            <a href="{% url 'user_profile' comment.user.username %}" class="text-decoration-none">
                                                                <strong>{{ comment.user.username }}</strong>
                                                            </a>
                                                            <small class="text-muted">{{ comment.created_at|date:"d M H:i" }}</small>
                                                        </div>
                                                        <p class="mb-0">{{ comment.content }}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {% if user.is_authenticated and comment|can_delete_comment:user %}
                                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-comment-btn"
                                                    data-comment-id="{{ comment.id }}" title="Удалить комментарий">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                {% if user.is_authenticated %}
                                <form class="add-comment-form" data-post-id="{{ post.id }}">
                                    {% csrf_token %}
                                    <div class="input-group">
                                        <textarea name="content" class="form-control" placeholder="Напишите комментарий..." rows="1"></textarea>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </form>
                                {% else %}
                                <div class="alert alert-warning text-center">
                                    <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">Войдите</a>,
                                    чтобы оставить комментарий
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="card shadow text-center">
                    <div class="card-body">
                        <h5 class="text-muted">Пока нет публикаций</h5>
                        <p class="text-muted">Будьте первым, кто опубликует что-то интересное!</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% if user.is_authenticated %}
<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Создать пост</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'create_post_from_feed' %}" enctype="multipart/form-data" id="createPostForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Текст поста</label>
                        <textarea name="content" class="form-control" rows="4" placeholder="Что у вас нового?" required></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Тип контента</label>
                            <select name="post_type" class="form-select" id="postTypeSelect">
                                <option value="text">Только текст</option>
                                <option value="image">Изображение</option>
                                <option value="video">Видео</option>
                                <option value="audio">Аудио</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Медиа файл</label>
                            <input type="file" name="media_file" class="form-control" id="mediaFileInput" accept="image/*,video/*,audio/*">
                            <div class="form-text">Вы можете добавить изображение, видео или аудио</div>
                        </div>
                    </div>

                    <div class="row mb-3" id="audioCoverSection" style="display: none;">
                        <div class="col-12">
                            <label class="form-label">Обложка для аудио (необязательно)</label>
                            <input type="file" name="audio_cover" class="form-control" accept="image/*" id="audioCoverInput">
                            <div class="form-text">
                                Вы можете загрузить обложку для аудио файла.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="audioNameSection" style="display: none;">
                        <label class="form-label">Название аудио</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="audioNameInput" placeholder="Название будет сгенерировано автоматически" readonly>
                            <button type="button" class="btn btn-outline-secondary" id="editAudioNameBtn">
                                <i class="bi bi-pencil"></i> Изменить
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Опубликовать</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" id="editAudioTitleModal" tabindex="-1" aria-labelledby="editAudioTitleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAudioTitleModalLabel">Изменить название аудио</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newAudioTitle" class="form-label">Новое название</label>
                    <input type="text" class="form-control" id="newAudioTitle" placeholder="Введите название аудио">
                </div>
                <div class="form-text">
                    Текущее название: <span id="currentAudioTitle" class="fst-italic"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveAudioTitleBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeletePostModal" tabindex="-1" aria-labelledby="confirmDeletePostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeletePostModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить этот пост? Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePostBtn">Да, удалить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteCommentModal" tabindex="-1" aria-labelledby="confirmDeleteCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteCommentModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить этот комментарий? Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteCommentBtn">Да, удалить</button>
            </div>
        </div>
    </div>
</div>

<style>
    .post-card {
        border: none;
        border-radius: 15px;
        background: var(--card-bg);
        color: var(--card-text);
        border: 1px solid var(--border-color);
    }

    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
    }

    .like-btn.liked {
        background-color: #dc3545;
        color: white;
    }

    .comment {
        background-color: var(--bg-secondary) !important;
    }

    .btn-primary {
        background: linear-gradient(45deg, var(--btn-primary-bg), var(--btn-primary-hover));
        border: none;
        border-radius: 10px;
    }

    .btn-primary:hover {
        background: linear-gradient(45deg, var(--btn-primary-hover), #004085);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .modal-content {
        border-radius: 15px;
        border: none;
        background: var(--modal-bg);
        color: var(--modal-text);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    .delete-comment-btn {
        opacity: 0.7;
        transition: opacity 0.3s;
    }

    .delete-comment-btn:hover {
        opacity: 1;
    }

    .audio-player-side {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--border-color);
    }

    .audio-side-cover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        flex-shrink: 0;
    }

    .audio-side-cover:hover {
        transform: scale(1.05);
    }

    .audio-side-default {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .audio-title {
        color: var(--text-primary);
        font-size: 1rem;
        word-break: break-word;
        line-height: 1.2;
        margin-bottom: 8px;
        display: block;
    }

    .audio-side-controls {
        border-radius: 8px;
        background: var(--bg-card);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        height: 40px;
    }

    .edit-audio-title-btn {
        font-size: 0.8rem;
        padding: 2px 6px;
    }

    @media (max-width: 768px) {
        .audio-player-side {
            padding: 10px;
        }

        .audio-side-cover,
        .audio-side-default {
            width: 60px !important;
            height: 60px !important;
        }

        .audio-title {
            font-size: 0.9rem;
        }

        .audio-side-controls {
            height: 35px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let postToDelete = null;
    let commentToDelete = null;
    let currentEditingPostId = null;

    // Простая функция для получения CSRF токена
    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    // Упрощенная обработка ответов
    async function handleResponse(response) {
        const text = await response.text();

        try {
            const data = JSON.parse(text);
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            }
            return data;
        } catch (e) {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            throw new Error('Сервер вернул неверный формат данных');
        }
    }

    // Показать ошибку
    function showError(message) {
        console.error('Error:', message);
        if (message.includes('HTTP error') || message.includes('Сервер вернул неверный формат')) {
            alert('Ошибка соединения с сервером. Пожалуйста, попробуйте еще раз.');
        } else {
            alert(message);
        }
    }

    // Форматирование имени аудио файла
    function formatAudioFilename(filename) {
        if (!filename) return 'Аудио файл';
        let name = filename.replace(/\.(mp3|wav|ogg|flac|m4a)$/i, '');
        name = name.replace(/_\d{8,}$/, '');
        name = name.replace(/_/g, ' ');
        const parts = name.split(/\s*-\s*/);

        if (parts.length >= 2) {
            const artist = formatNamePart(parts[0]);
            const title = formatNamePart(parts.slice(1).join(' - '));
            return `${artist} - ${title}`;
        } else {
            const words = name.split(' ');
            if (words.length >= 2) {
                const artist = formatNamePart(words[0]);
                const title = formatNamePart(words.slice(1).join(' '));
                return `${artist} - ${title}`;
            } else {
                return formatNamePart(name);
            }
        }
    }

    function formatNamePart(part) {
        return part
            .split(' ')
            .map(word => {
                if (word.length <= 2 && !word.match(/[A-Z]/)) {
                    return word.toLowerCase();
                }
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            })
            .join(' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    // Обработчики удаления
    function handleCommentDeleteClick() {
        commentToDelete = this.dataset.commentId;
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteCommentModal'));
        confirmModal.show();
    }

    function handlePostDeleteClick() {
        postToDelete = this.dataset.postId;
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeletePostModal'));
        confirmModal.show();
    }

    // Удаление комментария
    document.getElementById('confirmDeleteCommentBtn').addEventListener('click', function() {
        if (!commentToDelete) return;

        const commentElement = document.getElementById(`comment-${commentToDelete}`);
        const commentBtn = commentElement?.closest('.post-card')?.querySelector('.comment-btn .comments-count');

        // Сразу закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteCommentModal'));
        if (modal) {
            modal.hide();
        }

        fetch(`/delete-comment/${commentToDelete}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(handleResponse)
        .then(data => {
            if (data.success) {
                if (commentElement) {
                    commentElement.remove();
                }
                if (commentBtn) {
                    commentBtn.textContent = data.comments_count;
                }
                console.log('Комментарий удален');
            } else {
                throw new Error(data.error || 'Неизвестная ошибка');
            }
        })
        .catch(error => {
            showError('Ошибка при удалении комментария: ' + error.message);
        })
        .finally(() => {
            commentToDelete = null;
        });
    });

    // Удаление поста
    document.getElementById('confirmDeletePostBtn').addEventListener('click', function() {
        if (!postToDelete) return;

        // Сразу закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeletePostModal'));
        if (modal) {
            modal.hide();
        }

        fetch(`/delete-post/${postToDelete}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(handleResponse)
        .then(data => {
            if (data.success) {
                const postElement = document.getElementById(`post-${postToDelete}`);
                if (postElement) {
                    postElement.remove();
                }
                console.log('Пост удален');
            } else {
                throw new Error(data.error || 'Неизвестная ошибка');
            }
        })
        .catch(error => {
            showError('Ошибка при удалении поста: ' + error.message);
        })
        .finally(() => {
            postToDelete = null;
        });
    });

    // Лайки
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const likeBtn = this;
            const likesCount = this.querySelector('.likes-count');

            fetch(`/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(handleResponse)
            .then(data => {
                likesCount.textContent = data.likes_count;
                if (data.liked) {
                    likeBtn.classList.add('liked');
                    likeBtn.querySelector('i').className = 'bi bi-heart-fill';
                } else {
                    likeBtn.classList.remove('liked');
                    likeBtn.querySelector('i').className = 'bi bi-heart';
                }
            })
            .catch(error => {
                showError('Ошибка при установке лайка: ' + error.message);
            });
        });
    });

    // Комментарии
    document.querySelectorAll('.add-comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const textarea = this.querySelector('textarea');
            const content = textarea.value.trim();
            const commentBtn = document.querySelector(`[data-bs-target="#comments-${postId}"] .comments-count`);
            const submitBtn = this.querySelector('button[type="submit"]');

            // Проверяем что комментарий не пустой
            if (!content) {
                alert('Введите текст комментария');
                return;
            }

            // Блокируем кнопку на время отправки
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass"></i>';

            // Создаем FormData
            const formData = new FormData();
            formData.append('content', content);
            formData.append('csrfmiddlewaretoken', getCSRFToken());

            fetch(`/comment/${postId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                // Не устанавливаем Content-Type для FormData - браузер сделает это сам
                // 'Content-Type': 'multipart/form-data' - НЕ НУЖНО!
                },
            })
            .then(handleResponse)
            .then(data => {
                if (data.success) {
                    // Очищаем текстовое поле
                    textarea.value = '';

                    // Обновляем счетчик комментариев
                    if (commentBtn) {
                        commentBtn.textContent = data.comments_count;
                    }

                    // Добавляем новый комментарий в список
                    const commentsList = this.closest('.comments-section').querySelector('.comments-list');
                    const newComment = document.createElement('div');
                    newComment.className = 'comment mb-2 p-2 rounded position-relative';
                    newComment.id = `comment-${data.comment_id}`;

                    // Формируем HTML для нового комментария
                    newComment.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <div style="position: relative; width: 32px; height: 32px; margin-right: 8px;">
                                        <div style="width: 24px; height: 24px; background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover)); display: flex; align-items: center; justify-content: center; color: white; position: absolute; top: 4px; left: 4px; z-index: 1; border-radius: 4px;">
                                            <i class="bi bi-person-fill" style="font-size: 0.7rem;"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <a href="/profile/${data.user}/" class="text-decoration-none">
                                                <strong>${data.user}</strong>
                                            </a>
                                            <small class="text-muted">${data.created_at}</small>
                                        </div>
                                        <p class="mb-0">${data.content}</p>
                                    </div>
                                </div>
                            </div>
                            ${data.can_delete ? `
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 delete-comment-btn"
                                    data-comment-id="${data.comment_id}" title="Удалить комментарий">
                                <i class="bi bi-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    `;

                    commentsList.appendChild(newComment);

                    // Добавляем обработчик для новой кнопки удаления
                    const newDeleteBtn = newComment.querySelector('.delete-comment-btn');
                    if (newDeleteBtn) {
                        newDeleteBtn.addEventListener('click', handleCommentDeleteClick);
                    }

                    console.log('Комментарий добавлен');
                } else {
                    throw new Error(data.error || 'Неизвестная ошибка');
                }
            })
            .catch(error => {
                console.error('Comment error details:', error);
                showError('Ошибка при добавлении комментария: ' + error.message);
            })
            .finally(() => {
                // Восстанавливаем кнопку
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });

    // Управление созданием поста
    const postTypeSelect = document.getElementById('postTypeSelect');
    const mediaFileInput = document.getElementById('mediaFileInput');
    const audioCoverSection = document.getElementById('audioCoverSection');
    const audioNameSection = document.getElementById('audioNameSection');
    const audioNameInput = document.getElementById('audioNameInput');
    const editAudioNameBtn = document.getElementById('editAudioNameBtn');

    if (postTypeSelect) {
        postTypeSelect.addEventListener('change', function() {
            if (this.value === 'audio') {
                audioCoverSection.style.display = 'block';
                audioNameSection.style.display = 'block';
            } else {
                audioCoverSection.style.display = 'none';
                audioNameSection.style.display = 'none';
            }
        });
    }

    if (mediaFileInput) {
        mediaFileInput.addEventListener('change', function() {
            const postType = postTypeSelect ? postTypeSelect.value : 'text';
            if (postType === 'audio' && this.files.length > 0) {
                const file = this.files[0];
                const formattedName = formatAudioFilename(file.name);
                audioNameInput.value = formattedName;
            }
        });
    }

    if (editAudioNameBtn) {
        editAudioNameBtn.addEventListener('click', function() {
            audioNameInput.readOnly = false;
            audioNameInput.focus();
            this.style.display = 'none';
        });
    }

    // Редактирование названия аудио
    document.querySelectorAll('.edit-audio-title-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const currentTitle = document.getElementById(`audio-title-${postId}`).textContent;
            currentEditingPostId = postId;
            document.getElementById('currentAudioTitle').textContent = currentTitle;
            document.getElementById('newAudioTitle').value = currentTitle;
            const modal = new bootstrap.Modal(document.getElementById('editAudioTitleModal'));
            modal.show();
        });
    });

    document.getElementById('saveAudioTitleBtn').addEventListener('click', function() {
        if (!currentEditingPostId) return;
        const newTitle = document.getElementById('newAudioTitle').value.trim();
        if (!newTitle) {
            alert('Введите название аудио');
            return;
        }
        const titleElement = document.getElementById(`audio-title-${currentEditingPostId}`);
        if (titleElement) {
            titleElement.textContent = newTitle;
        }
        const modal = bootstrap.Modal.getInstance(document.getElementById('editAudioTitleModal'));
        if (modal) {
            modal.hide();
        }
        currentEditingPostId = null;
    });

    // Сброс формы создания поста при закрытии модального окна
    const createPostModal = document.getElementById('createPostModal');
    if (createPostModal) {
        createPostModal.addEventListener('hidden.bs.modal', function() {
            audioCoverSection.style.display = 'none';
            audioNameSection.style.display = 'none';
            audioNameInput.value = '';
            audioNameInput.readOnly = true;
            if (editAudioNameBtn) {
                editAudioNameBtn.style.display = 'block';
            }
        });
    }

    // Сброс переменных при закрытии модальных окон
    document.getElementById('confirmDeletePostModal').addEventListener('hidden.bs.modal', function() {
        postToDelete = null;
    });

    document.getElementById('confirmDeleteCommentModal').addEventListener('hidden.bs.modal', function() {
        commentToDelete = null;
    });

    document.getElementById('editAudioTitleModal').addEventListener('hidden.bs.modal', function() {
        currentEditingPostId = null;
    });

    // Инициализация обработчиков удаления при загрузке страницы
    document.querySelectorAll('.delete-comment-btn').forEach(btn => {
        btn.addEventListener('click', handleCommentDeleteClick);
    });

    document.querySelectorAll('.delete-post-btn').forEach(btn => {
        btn.addEventListener('click', handlePostDeleteClick);
    });

    // Обработка отправки формы создания поста
    const createPostForm = document.getElementById('createPostForm');
    if (createPostForm) {
        createPostForm.addEventListener('submit', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('createPostModal'));
            if (modal) {
                modal.hide();
            }
        });
    }

    // Автоматическое увеличение высоты textarea при вводе комментария
    document.querySelectorAll('.add-comment-form textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    });
});
</script>
{% endblock %}